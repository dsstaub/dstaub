<!DOCTYPE html>
<html lang="en" class="bg-gray-900 text-white">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
  <title>Flight Tracker</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <style>
    .dragging {
      opacity: 0.4;
    }
    .editing {
      outline: 2px dashed white;
      outline-offset: 2px;
      background-color: #1e293b;
    }
    .drawer {
      transition: max-height 0.3s ease;
      overflow: hidden;
      max-height: 0;
    }
    .drawer.open {
      max-height: 60px;
    }
  </style>
</head>
<body class="flex flex-col h-screen font-mono text-xl">
  <textarea id="input" placeholder="Paste flight data here..." class="w-full h-24 p-2 bg-gray-800 text-white resize-none text-lg"></textarea>
  <div class="flex gap-2">
    <button onclick="createCards()" class="flex-1 py-3 bg-blue-600 hover:bg-blue-700">Generate Cards</button>
    <button onclick="clearAll()" class="flex-1 py-3 bg-red-600 hover:bg-red-700">Clear All</button>
  </div>
  <div class="flex-1 flex gap-4 p-2 overflow-hidden">
    <!-- Active Column -->
    <div class="flex flex-col flex-1 bg-gray-800 rounded-lg p-2">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-lg font-bold">Active Flights</h2>
        <select onchange="toggleSort('activeColumn', this.value)" class="bg-gray-700 text-white px-2 py-1 rounded">
          <option value="manual">Manual</option>
          <option value="az">A-Z</option>
        </select>
      </div>
      <div id="activeColumn" class="flex-1 overflow-y-auto space-y-2 p-1" ondragover="allowDrop(event)" ondrop="drop(event, 'activeColumn')"></div>
    </div>

    <!-- Completed Column -->
    <div class="flex flex-col flex-1 bg-gray-800 rounded-lg p-2">
      <div class="flex justify-between items-center mb-2">
        <h2 class="text-lg font-bold">Completed</h2>
        <select onchange="toggleSort('completeColumn', this.value)" class="bg-gray-700 text-white px-2 py-1 rounded">
          <option value="manual">Manual</option>
          <option value="az">A-Z</option>
        </select>
      </div>
      <div id="completeColumn" class="flex-1 overflow-y-auto space-y-2 p-1" ondragover="allowDrop(event)" ondrop="drop(event, 'completeColumn')"></div>
    </div>
  </div>

  <script>
    let dragged = null;
    let manualOrder = { activeColumn: [], completeColumn: [] };
    let currentSort = { activeColumn: "manual", completeColumn: "manual" };

    function classify(text) {
      return text.includes("_TF_") ? "bg-red-700" :
             text.includes("_QT_") ? "bg-green-700" : "bg-gray-700";
    }

    function createCard(text, colId = "activeColumn") {
      const wrapper = document.createElement("div");
      wrapper.draggable = true;
      wrapper.className = "relative group";

      const card = document.createElement("div");
      card.className = `${classify(text)} text-white text-3xl font-bold px-4 py-4 rounded cursor-grab`;
      card.textContent = text;

      card.ondragstart = () => {
        dragged = wrapper;
        wrapper.classList.add("dragging");
      };
      card.ondragend = () => {
        dragged = null;
        wrapper.classList.remove("dragging");
        saveOrder();
      };

      // Tap opens drawer
      card.ontouchstart = (e) => {
        closeAllDrawers();
        wrapper.querySelector(".drawer").classList.add("open");
      };
      card.onclick = (e) => {
        if (e.detail === 2) enableEdit(card);
        else closeAllDrawers();
      };

      // Edit mode
      card.onkeydown = (e) => {
        if (e.key === "Enter") card.blur();
      };
      card.onblur = () => {
        if (card.isContentEditable) {
          card.contentEditable = false;
          card.classList.remove("editing");
          saveOrder();
        }
      };

      // Drawer buttons
      const drawer = document.createElement("div");
      drawer.className = "drawer flex gap-2 justify-between px-4";
      drawer.innerHTML = `
        <button class="bg-green-600 hover:bg-green-700 px-3 py-1 rounded w-1/2" onclick="moveTo('completeColumn', this)">Complete</button>
        <button class="bg-red-600 hover:bg-red-700 px-3 py-1 rounded w-1/2" onclick="removeCard(this)">Delete</button>
      `;

      wrapper.appendChild(card);
      wrapper.appendChild(drawer);
      manualOrder[colId].push(wrapper);
      return wrapper;
    }

    function enableEdit(card) {
      closeAllDrawers();
      card.contentEditable = true;
      card.classList.add("editing");
      card.focus();
      const range = document.createRange();
      range.selectNodeContents(card);
      const sel = window.getSelection();
      sel.removeAllRanges();
      sel.addRange(range);
    }

    function moveTo(targetId, btn) {
      const card = btn.closest(".group");
      document.getElementById(targetId).appendChild(card);
      closeAllDrawers();
      saveOrder();
    }

    function removeCard(btn) {
      btn.closest(".group").remove();
      saveOrder();
    }

    function createCards() {
      document.getElementById("activeColumn").innerHTML = "";
      document.getElementById("completeColumn").innerHTML = "";
      manualOrder = { activeColumn: [], completeColumn: [] };

      const lines = document.getElementById("input").value.trim().split("\n");
      lines.forEach(line => {
        if (!line.trim()) return;
        const card = createCard(line.trim(), "activeColumn");
        document.getElementById("activeColumn").appendChild(card);
      });

      saveOrder();
    }

    function allowDrop(e) {
      e.preventDefault();
    }

    function drop(e, columnId) {
      e.preventDefault();
      const column = document.getElementById(columnId);
      if (dragged && column) {
        column.appendChild(dragged);
        saveOrder();
      }
    }

    function closeAllDrawers() {
      document.querySelectorAll(".drawer.open").forEach(d => d.classList.remove("open"));
    }

    function toggleSort(id, mode) {
      currentSort[id] = mode;
      if (mode === "az") {
        const column = document.getElementById(id);
        const sorted = [...column.children].sort((a, b) =>
          a.innerText.localeCompare(b.innerText)
        );
        column.innerHTML = "";
        sorted.forEach(el => column.appendChild(el));
      } else {
        const col = document.getElementById(id);
        col.innerHTML = "";
        manualOrder[id].forEach(el => col.appendChild(el));
      }
    }

    function saveOrder() {
      ["activeColumn", "completeColumn"].forEach(id => {
        const col = document.getElementById(id);
        manualOrder[id] = [...col.children];
        const values = [...col.children].map(c => c.querySelector("div").textContent);
        localStorage.setItem("order_" + id, JSON.stringify(values));
      });
    }

    function loadState() {
      ["activeColumn", "completeColumn"].forEach(id => {
        const col = document.getElementById(id);
        manualOrder[id] = [];
        col.innerHTML = "";

        const data = JSON.parse(localStorage.getItem("order_" + id) || "[]");
        data.forEach(text => {
          const el = createCard(text, id);
          col.appendChild(el);
        });
      });
    }

    function clearAll() {
      if (confirm("Clear all cards?")) {
        localStorage.clear();
        document.getElementById("activeColumn").innerHTML = "";
        document.getElementById("completeColumn").innerHTML = "";
        manualOrder = { activeColumn: [], completeColumn: [] };
      }
    }

    window.addEventListener("click", (e) => {
      if (![...document.querySelectorAll(".card")].some(el => el.contains(e.target))) {
        closeAllDrawers();
      }
    });

    loadState();
  </script>
</body>
</html>